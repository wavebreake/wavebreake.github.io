---
layout: post
title:  "ctyun主机服务与对象存储服务内网互通方案"
date:   2022-07-15 12:00:00 +0800
categories: ctyun
---

## 概述

本文用以描述ctyun主机服务与对象存储服务内网互通方案。

## 场景总览

以下涉及场景与对应方案来自不同项目结论，也可能适用暂无方案的场景。

|                 | 弹性云主机(自研) | 物理机服务(自研) | 弹性云主机(合营) | 物理机服务(合营) |
| --------------- | --------- | --------- | --------- | --------- |
| **对象存储（经典版）Ⅰ型** | 云专线       |           |           |           |
| **对象存储（经典版）Ⅱ型** |           |           | VPC终端节点   | VPC终端节点   |
| **对象存储（融合版）**   | EIP       | 独立核心vlan  | 1:N NAT   |           |
| **对象存储（原生版）Ⅰ型** | 原生互通      | 原生互通      |           |           |

## VPC终端节点方式

1. 功能与性能说明

![](https://raw.githubusercontent.com/wavebreake/imagehosting/main/vpce.png)

在同一区域中，VPC 终端节点可以建立终端节点（VPC 内云资源）到终端节点服务（用户私有服务、云服务）的便捷、安全、私密 连接通道。上图中，VPC1 中的弹性云主机通过终端节点 2 实现本区 域内的 OBS 内网访问。

2. 适用范围与约束限制

适用范围：合营节点。

3. 租户开通流程

ctyun控制台自助开通。

## 独立核心vlan方式

1. 功能与性能说明

![](https://raw.githubusercontent.com/wavebreake/imagehosting/main/vlan.png)

![](https://raw.githubusercontent.com/wavebreake/imagehosting/main/vlan-1.png)

裸金属通过内网地址与存储内网地址直接互通。如果现网裸金属服务器预留了多余网卡，则使用专用网卡，用于连接媒体存储；如现网裸金属服务器无多余网卡，则在原业务网卡上起vlan子接口，用于连接媒体存储。媒体存储侧应利用服务器上的软件防火墙（如：iptables）做好安全防护。

2. 适用范围与约束限制

适用范围：裸金属与对象存储(融合版)位于同一节点。

约束限制：裸金属网卡带宽限制。

3. 租户开通流程

待定

## EIP方式(合营)

1. 功能与性能说明

![](https://raw.githubusercontent.com/wavebreake/imagehosting/main/eip.png)

合营池云主机在边界墙进行1:N NAT到私网地址，访问媒体存储私网地址。媒体存储侧应利用服务器上的软件防火墙（如：iptables）做好安全防护。

2. 适用范围与约束限制

该部分带宽/流量不计费，合营池计费模块无需改造，媒体存储/媒体存储需配置该部分带宽/流量不计费。

3. 租户开通流程

待定

## EIP方式(自研)

1. 功能与性能说明

![](https://raw.githubusercontent.com/wavebreake/imagehosting/main/eip-1.png)

![](https://raw.githubusercontent.com/wavebreake/imagehosting/main/eip-2.png)

云主机采用1:1 NAT，通过公网地址访问媒体存储私网地址。该方案流量不出资源池，不会占用出口公网带宽。

为防止东西大流量攻击情况下造成网络瘫痪，云主机访问媒体存储流量不经过防火墙，媒体存储侧应利用服务器上的软件防火墙（如：iptables）做好安全防护。

针对大流量、高性能需求，租户需将VPC网关从虚拟网关升级为物理网关；每个VPC网关能承载的带宽上限为10G，若客户流量需求超过10G，需要与客户沟通采用多个VPC网关共同承载客户的大流量业务。

2. 适用范围与约束限制

云主机侧：云主机通过公网访问媒体存储的出向带宽向用户免费，该部分带宽作为增补带宽的方式免费赠予客户。

媒体存储池侧：对于目的地址是内网IP的访问带宽不计费。

该方案需为每台有内网访问媒体存储需求的云主机绑定一个公网IP，对公网IP地址是种浪费。对于没有绑定公网IP的云主机，无法采用本方案访问媒体存储。且内网速率受限于公网带宽。(PS：可以用假EIP解决此问题)

3. 租户开通流程

待定

## 云专线方式

1. 功能与性能说明

VPC<——>云平台核心<——>POP<——>对象存储核心

2. 适用范围与约束限制

约束限制：存量案例为业务独立部署了POP。

3. 租户开通流程

待定